# Fully Automated Release Workflow
#
# This workflow automatically creates releases when version bumps are merged to main.
# No manual intervention required - just merge your PR with an updated DESCRIPTION version.
#
# How it works:
# 1. Detects version changes in DESCRIPTION when PR is merged to main
# 2. Automatically creates a git tag (v{version})
# 3. Runs all quality checks (tests, R CMD check, coverage)
# 4. Generates release notes from NEWS.md
# 5. Creates GitHub release with package tarball
# 6. Publishes immediately - no approval gates
#
# To trigger a release:
#   1. Update version in DESCRIPTION (e.g., 0.3.0 â†’ 0.4.0)
#   2. Update NEWS.md with release notes
#   3. Merge PR to main
#   4. Release happens automatically!

name: Auto Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force release even if version unchanged'
        required: false
        type: boolean
        default: false

env:
  R_VERSION: 'release'

jobs:
  detect-version-change:
    name: Detect Version Change
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
      previous_version: ${{ steps.check.outputs.previous_version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to compare

      - name: Check for version change
        id: check
        run: |
          # Get current version from DESCRIPTION
          CURRENT_VERSION=$(grep "^Version:" DESCRIPTION | sed 's/Version: //')
          echo "Current version: $CURRENT_VERSION"

          # Get previous version from parent commit
          git checkout HEAD~1
          PREVIOUS_VERSION=$(grep "^Version:" DESCRIPTION | sed 's/Version: //')
          git checkout -
          echo "Previous version: $PREVIOUS_VERSION"

          # Check if version changed or force_release is true
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ] || [ "${{ inputs.force_release }}" = "true" ]; then
            echo "Version changed: $PREVIOUS_VERSION â†’ $CURRENT_VERSION"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "previous_version=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT
          else
            echo "No version change detected - skipping release"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  create-release:
    name: Create Release
    needs: detect-version-change
    if: needs.detect-version-change.outputs.should_release == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ env.R_VERSION }}
          use-public-rspm: true

      - uses: r-lib/actions/setup-tinytex@v2

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::rcmdcheck, any::pkgbuild, any::covr, any::desc
          needs: check

      - name: Run R CMD check
        uses: r-lib/actions/check-r-package@v2
        with:
          build_args: 'c("--no-manual","--compact-vignettes=gs+qpdf")'
          error-on: '"error"'

      - name: Run tests with coverage
        run: |
          coverage <- covr::package_coverage(quiet = FALSE)
          percent <- covr::percent_coverage(coverage)
          cat(sprintf("\nâœ“ Test coverage: %.1f%%\n", percent))
        shell: Rscript {0}

      - name: Build package tarball
        id: build
        run: |
          tarball <- pkgbuild::build(dest_path = ".", binary = FALSE, vignettes = TRUE, manual = FALSE)
          cat(sprintf("tarball=%s\n", tarball), file = Sys.getenv("GITHUB_OUTPUT"), append = TRUE)
          cat(sprintf("âœ“ Built: %s\n", tarball))
        shell: Rscript {0}

      - name: Create git tag
        run: |
          VERSION="${{ needs.detect-version-change.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create annotated tag with release info
          git tag -a "v$VERSION" -m "Release v$VERSION" || true
          git push origin "v$VERSION" || true

          echo "âœ“ Created and pushed tag v$VERSION"

      - name: Extract release notes from NEWS.md
        id: notes
        run: |
          VERSION="${{ needs.detect-version-change.outputs.version }}"

          # Extract section for this version from NEWS.md
          if [ -f "NEWS.md" ]; then
            # Get everything between this version and the next version header
            awk "/^# emburden $VERSION/,/^# emburden [0-9]/" NEWS.md |
              head -n -1 |
              tail -n +2 > release-notes.md

            # If nothing extracted, provide default
            if [ ! -s release-notes.md ]; then
              echo "Release v$VERSION" > release-notes.md
              echo "" >> release-notes.md
              echo "See [NEWS.md](NEWS.md) for details." >> release-notes.md
            fi
          else
            echo "Release v$VERSION" > release-notes.md
          fi

          # Add installation instructions
          cat >> release-notes.md <<EOF

          ## Installation

          \`\`\`r
          # Install from GitHub
          # install.packages("remotes")
          remotes::install_github("ScheierVentures/emburden@v$VERSION")
          \`\`\`

          ## Package Validation

          All automated checks passed:
          - âœ… R CMD check (0 errors, 0 warnings)
          - âœ… All tests passing
          - âœ… Test coverage threshold met
          - âœ… Package builds successfully
          EOF

          cat release-notes.md

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.detect-version-change.outputs.version }}
          name: emburden v${{ needs.detect-version-change.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: ${{ steps.build.outputs.tarball }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          cat <<EOF

          ðŸŽ‰ RELEASE PUBLISHED SUCCESSFULLY! ðŸŽ‰

          Version: v${{ needs.detect-version-change.outputs.version }}
          Previous: v${{ needs.detect-version-change.outputs.previous_version }}
          Release URL: ${{ steps.create_release.outputs.url }}

          âœ… All quality checks passed
          âœ… Git tag created and pushed
          âœ… GitHub release published
          âœ… Package tarball attached

          Users can now install with:
          remotes::install_github("ScheierVentures/emburden@v${{ needs.detect-version-change.outputs.version }}")

          EOF
