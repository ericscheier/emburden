name: Auto-Merge Version Bump PRs

# Automatically merge and squash PRs when triggered by auto-merge tag
# The release-version.sh script creates an auto-merge/vX.X.X tag
# which triggers this workflow to:
# 1. Verify all PR checks are passing
# 2. Auto-merge the PR with squash
# 3. Delete the auto-merge tag

on:
  push:
    tags:
      - 'auto-merge/**'  # Triggers when release-version.sh creates auto-merge tag

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    name: Auto-merge version bump PR
    runs-on: ubuntu-latest

    steps:
      - name: Extract version from tag
        id: get_version
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG_NAME#auto-merge/}"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Triggered by tag: $TAG_NAME"
          echo "Version: $VERSION"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.get_version.outputs.tag_name }}
          fetch-depth: 0

      - name: Find PR for this tag
        id: get_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the commit SHA that this tag points to
          COMMIT_SHA=$(git rev-parse ${{ steps.get_version.outputs.tag_name }})
          echo "Tag points to commit: $COMMIT_SHA"

          # Find PR with this commit in its head
          PR_NUMBER=$(gh pr list --state open --base main --json number,headRefOid,headRefName \
            --jq ".[] | select(.headRefOid == \"$COMMIT_SHA\") | .number" | head -1)

          if [ -z "$PR_NUMBER" ]; then
            echo "âŒ No open PR found for commit $COMMIT_SHA"
            exit 1
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "âœ… Found PR #$PR_NUMBER"

      - name: Check if PR includes version bump
        id: check_version_bump
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.get_pr.outputs.pr_number }}"

          echo "Checking if PR #$PR_NUMBER includes version bump..."

          # Get list of changed files
          CHANGED_FILES=$(gh pr view "$PR_NUMBER" --json files --jq '.files[].path')

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check if version files were modified
          HAS_DESCRIPTION=$(echo "$CHANGED_FILES" | grep -c "^DESCRIPTION$" || true)
          HAS_CITATION=$(echo "$CHANGED_FILES" | grep -c "^inst/CITATION$" || true)
          HAS_ZENODO=$(echo "$CHANGED_FILES" | grep -c "^.zenodo.json$" || true)

          if [ "$HAS_DESCRIPTION" -gt 0 ] && [ "$HAS_CITATION" -gt 0 ] && [ "$HAS_ZENODO" -gt 0 ]; then
            echo "âœ… PR includes version bump (DESCRIPTION, inst/CITATION, .zenodo.json modified)"
            echo "has_version_bump=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ PR does not include complete version bump"
            echo "   DESCRIPTION: $HAS_DESCRIPTION"
            echo "   inst/CITATION: $HAS_CITATION"
            echo "   .zenodo.json: $HAS_ZENODO"
            echo "has_version_bump=false" >> $GITHUB_OUTPUT
          fi

      - name: Wait for and check CI status
        id: check_status
        if: steps.check_version_bump.outputs.has_version_bump == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.get_pr.outputs.pr_number }}"
          MAX_WAIT_MINUTES=30
          CHECK_INTERVAL_SECONDS=30
          MAX_ITERATIONS=$((MAX_WAIT_MINUTES * 60 / CHECK_INTERVAL_SECONDS))

          echo "Waiting for CI checks to complete on PR #$PR_NUMBER..."
          echo "Will check every ${CHECK_INTERVAL_SECONDS}s for up to ${MAX_WAIT_MINUTES} minutes"
          echo ""

          for i in $(seq 1 $MAX_ITERATIONS); do
            echo "=== Check attempt $i/$MAX_ITERATIONS ==="

            # Get PR checks using simpler gh pr checks command
            CHECKS_OUTPUT=$(gh pr checks "$PR_NUMBER" 2>&1 || true)

            # Count different status types - use xargs to trim whitespace and ensure numeric values
            # gh pr checks output format: <name><tab><status><tab><time><tab><url>
            # Exclude the auto-merge workflow itself and "skipping" checks from the count
            TOTAL_CHECKS=$(echo "$CHECKS_OUTPUT" | grep -vE "Auto-merge version bump" | grep -E $'\t(pass|fail|pending)\t' | wc -l | xargs)
            PASSED_CHECKS=$(echo "$CHECKS_OUTPUT" | grep -vE "Auto-merge version bump" | grep -E $'\tpass\t' | wc -l | xargs)
            FAILED_CHECKS=$(echo "$CHECKS_OUTPUT" | grep -vE "Auto-merge version bump" | grep -E $'\tfail\t' | wc -l | xargs)
            PENDING_CHECKS=$(echo "$CHECKS_OUTPUT" | grep -vE "Auto-merge version bump" | grep -E $'\tpending\t' | wc -l | xargs)

            # Ensure all variables are numeric (default to 0 if empty)
            TOTAL_CHECKS=${TOTAL_CHECKS:-0}
            PASSED_CHECKS=${PASSED_CHECKS:-0}
            FAILED_CHECKS=${FAILED_CHECKS:-0}
            PENDING_CHECKS=${PENDING_CHECKS:-0}

            echo "Total: $TOTAL_CHECKS | Passed: $PASSED_CHECKS | Failed: $FAILED_CHECKS | Pending: $PENDING_CHECKS"

            # Show current status
            if [ "$TOTAL_CHECKS" -gt 0 ]; then
              echo "$CHECKS_OUTPUT"
            fi

            # Check for failures
            if [ "$FAILED_CHECKS" -gt 0 ]; then
              echo ""
              echo "âŒ Some checks failed - not auto-merging"
              echo "all_checks_passed=false" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Check if all done and passed
            if [ "$TOTAL_CHECKS" -gt 0 ] && [ "$PENDING_CHECKS" -eq 0 ] && [ "$PASSED_CHECKS" -eq "$TOTAL_CHECKS" ]; then
              echo ""
              echo "âœ… All $TOTAL_CHECKS checks passed!"
              echo "all_checks_passed=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Still waiting
            if [ "$TOTAL_CHECKS" -eq 0 ]; then
              echo "â³ Waiting for checks to start..."
            else
              echo "â³ Waiting for $PENDING_CHECKS pending checks to complete..."
            fi

            # Don't sleep on last iteration
            if [ $i -lt $MAX_ITERATIONS ]; then
              sleep $CHECK_INTERVAL_SECONDS
            fi
          done

          echo ""
          echo "â° Timeout: Checks did not complete within ${MAX_WAIT_MINUTES} minutes"
          echo "all_checks_passed=false" >> $GITHUB_OUTPUT
          exit 0

      - name: Check if PR is approved
        id: check_approval
        if: |
          steps.check_version_bump.outputs.has_version_bump == 'true' &&
          steps.check_status.outputs.all_checks_passed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.get_pr.outputs.pr_number }}"

          # Check if PR requires reviews
          REQUIRED_REVIEWS=$(gh api "repos/${{ github.repository }}/branches/main/protection" --jq '.required_pull_request_reviews.required_approving_review_count' 2>/dev/null || echo "0")

          if [ "$REQUIRED_REVIEWS" -eq 0 ]; then
            echo "âœ… No reviews required"
            echo "is_approved=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check review status
          APPROVED_REVIEWS=$(gh pr view "$PR_NUMBER" --json reviews --jq '[.reviews[] | select(.state == "APPROVED")] | length')

          if [ "$APPROVED_REVIEWS" -ge "$REQUIRED_REVIEWS" ]; then
            echo "âœ… PR has required approvals ($APPROVED_REVIEWS/$REQUIRED_REVIEWS)"
            echo "is_approved=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ PR needs more approvals ($APPROVED_REVIEWS/$REQUIRED_REVIEWS)"
            echo "is_approved=false" >> $GITHUB_OUTPUT
          fi

      - name: Auto-merge PR
        if: |
          steps.check_version_bump.outputs.has_version_bump == 'true' &&
          steps.check_status.outputs.all_checks_passed == 'true' &&
          steps.check_approval.outputs.is_approved == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.get_pr.outputs.pr_number }}"

          echo "ðŸŽ‰ All conditions met - auto-merging PR #$PR_NUMBER with squash"

          # Merge immediately with squash strategy
          gh pr merge "$PR_NUMBER" --squash --delete-branch

          echo "âœ… PR #$PR_NUMBER merged and squashed"
          echo "âœ… Feature branch deleted"

      - name: Delete auto-merge tag
        if: |
          steps.check_version_bump.outputs.has_version_bump == 'true' &&
          steps.check_status.outputs.all_checks_passed == 'true' &&
          steps.check_approval.outputs.is_approved == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.get_version.outputs.tag_name }}"

          echo "ðŸ§¹ Cleaning up auto-merge tag: $TAG_NAME"
          git push origin ":refs/tags/$TAG_NAME"

          echo "âœ… Auto-merge tag deleted"

      - name: Summary
        if: always()
        run: |
          echo "## Auto-Merge Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ steps.get_pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_version_bump.outputs.has_version_bump }}" = "true" ]; then
            echo "âœ… Version bump detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ No version bump detected" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.check_status.outputs.all_checks_passed }}" = "true" ]; then
            echo "âœ… All checks passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check_status.outputs.all_checks_passed }}" = "false" ]; then
            echo "âŒ Checks not yet passing" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.check_approval.outputs.is_approved }}" = "true" ]; then
            echo "âœ… Required approvals received" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check_approval.outputs.is_approved }}" = "false" ]; then
            echo "âŒ Waiting for approvals" >> $GITHUB_STEP_SUMMARY
          fi
