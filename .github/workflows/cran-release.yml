name: CRAN Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on semantic version tags like v0.5.7, v1.0.0, etc.
  workflow_dispatch:  # Allow manual triggering for testing
    inputs:
      dry_run:
        description: 'Dry run mode (skip actual CRAN submission)'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  packages: read

jobs:
  validate-cran:
    # Only run on public repository (skip on private, don't fail)
    if: github.repository == 'ericscheier/emburden'
    name: Validate CRAN Package
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tarball: ${{ steps.build.outputs.tarball }}

    steps:
      - name: Verify repository
        run: |
          # This step is informational - the job-level if: prevents execution on wrong repo
          echo "âœ… Running on public repository: ${{ github.repository }}"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag is on main branch
        run: |
          # Get the branch(es) that contain this commit
          BRANCHES=$(git branch -r --contains ${{ github.sha }} | grep -o 'origin/[^ ]*' | sed 's|origin/||' || echo "")

          echo "Branches containing this commit: $BRANCHES"

          # Check if main is in the list
          if ! echo "$BRANCHES" | grep -q "^main$"; then
            echo "ERROR: This workflow can only run on tags created from the main branch"
            echo "Current commit is on: $BRANCHES"
            echo ""
            echo "To fix: Merge your PR to main first, then the auto-tag workflow will create the tag automatically"
            exit 1
          fi

          echo "âœ“ Verified: Tag is on main branch"

      - name: Extract version from tag
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(grep "^Version:" DESCRIPTION | sed 's/^Version: *//')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found version: $VERSION"

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          use-public-rspm: true

      - name: Validate CRAN_EMAIL secret
        run: |
          if [ -z "${{ secrets.CRAN_EMAIL }}" ]; then
            echo "âŒ ERROR: CRAN_EMAIL secret is not set"
            echo ""
            echo "To fix: Add CRAN_EMAIL secret in repository settings"
            echo "Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
            exit 1
          fi
          echo "âœ… CRAN_EMAIL secret is configured"

      - name: Setup R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::rcmdcheck
            any::devtools
          needs: check

      - name: Setup Pandoc
        uses: r-lib/actions/setup-pandoc@v2

      - name: Setup TinyTeX
        uses: r-lib/actions/setup-tinytex@v2
        env:
          TINYTEX_INSTALLER: TinyTeX

      - name: Install LaTeX packages for vignettes
        run: |
          # Install LaTeX packages needed for JSS vignette and general vignette building
          tlmgr install xcolor xstring fancyvrb framed

      - name: Build source package
        id: build
        run: |
          # Run R CMD build and show all output while capturing tarball name
          # Using tee to show output AND extract filename
          R CMD build . | tee /tmp/build-output.txt
          tarball=$(grep -o '[^/]*\.tar\.gz$' /tmp/build-output.txt)

          if [ -z "$tarball" ]; then
            echo "ERROR: Failed to extract tarball name from R CMD build output"
            echo "Build output:"
            cat /tmp/build-output.txt
            exit 1
          fi

          echo "tarball=$tarball" >> $GITHUB_OUTPUT
          echo "Built package: $tarball"

      - name: Run CRAN checks
        run: |
          Rscript -e "rcmdcheck::rcmdcheck(
            path = '${{ steps.build.outputs.tarball }}',
            args = c('--as-cran', '--no-manual'),
            error_on = 'warning',
            check_dir = 'check'
          )"

      - name: Upload check results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cran-check-results
          path: check/

      - name: Upload source tarball
        uses: actions/upload-artifact@v4
        with:
          name: r-package-source
          path: ${{ steps.build.outputs.tarball }}
          retention-days: 30

      - name: Submit to Win-builder (Optional)
        id: winbuilder
        continue-on-error: true
        run: |
          echo "ðŸ“¦ Submitting to Win-builder for Windows testing..."
          Rscript -e "devtools::check_win_release(email = '${{ secrets.CRAN_EMAIL }}')"
          echo ""
          echo "âœ… Submitted to Win-builder!"
          echo "â±ï¸  Results will be emailed to ${{ secrets.CRAN_EMAIL }} within ~30 minutes"
          echo ""
          echo "Check your email for Win-builder results before proceeding with CRAN submission."

      - name: Win-builder submission summary
        if: steps.winbuilder.outcome == 'success'
        run: |
          echo "### Win-builder Submission" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Package submitted to Win-builder for Windows testing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Results will be emailed to the configured CRAN_EMAIL address." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Win-builder results typically arrive within 30 minutes." >> $GITHUB_STEP_SUMMARY

  submit-to-cran:
    name: Submit to CRAN
    needs: validate-cran
    if: success()  # Only run if validate-cran succeeded
    runs-on: ubuntu-latest
    environment: cran-production  # Requires manual approval

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download package tarball
        uses: actions/download-artifact@v4
        with:
          name: r-package-source

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'

      - name: Install devtools
        run: Rscript -e "install.packages('devtools')"

      - name: Prepare CRAN submission
        id: prepare
        run: |
          VERSION="${{ needs.validate-cran.outputs.version }}"
          TARBALL="${{ needs.validate-cran.outputs.tarball }}"

          cat > cran_comments.md << EOF
          ## Resubmission
          This is version $VERSION of the emburden package.

          ## Test environments
          * Ubuntu 22.04 (GitHub Actions), R-release
          * Windows (GitHub Actions), R-release
          * macOS (GitHub Actions), R-release

          ## R CMD check results
          There were no ERRORs, WARNINGs, or NOTEs.

          ## Downstream dependencies
          There are currently no downstream dependencies for this package.
          EOF

          echo "Package: emburden v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "Tarball: $TARBALL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CRAN Submission Comments" >> $GITHUB_STEP_SUMMARY
          cat cran_comments.md >> $GITHUB_STEP_SUMMARY

      - name: Submit to CRAN
        if: |
          (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
          (github.event_name == 'workflow_dispatch' && inputs.dry_run == false)
        env:
          CRAN_EMAIL: ${{ secrets.CRAN_EMAIL }}
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run == true }}
        run: |
          TARBALL="${{ needs.validate-cran.outputs.tarball }}"

          if [ "$DRY_RUN" = "true" ]; then
            echo "ðŸ” DRY RUN MODE - Skipping actual CRAN submission"
            echo ""
            echo "Would submit: $TARBALL"
            echo "To email: $CRAN_EMAIL"
            echo ""
            echo "To submit for real, run workflow_dispatch with dry_run=false"
            exit 0
          fi

          echo "âœ… Package validated and ready for CRAN submission"
          echo ""
          echo "ðŸ“§ Submitting to CRAN automatically..."
          echo ""

          # Auto-submit to CRAN using configured CRAN_EMAIL
          Rscript -e "devtools::submit_cran('$TARBALL', email = Sys.getenv('CRAN_EMAIL'))"

          echo ""
          echo "âœ… Package submitted to CRAN!"
          echo "ðŸ“¬ Check $CRAN_EMAIL for CRAN submission confirmation"

      - name: Upload tarball to existing release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.validate-cran.outputs.version }}"
          TARBALL="${{ needs.validate-cran.outputs.tarball }}"
          TAG="v$VERSION"

          # The auto-release workflow already created the GitHub release
          # Just upload the CRAN-validated tarball as an additional asset
          echo "ðŸ“¦ Uploading CRAN-validated tarball to release $TAG..."

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG exists, uploading tarball..."
            gh release upload "$TAG" "$TARBALL" --clobber
            echo "âœ… Uploaded $TARBALL to release $TAG"
          else
            echo "âš ï¸  Release $TAG does not exist yet"
            echo "The auto-release workflow should create it shortly"
            echo "Skipping tarball upload"
          fi

      - name: Post-submission summary
        if: always()
        run: |
          echo "### CRAN Submission Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Package validated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Source tarball created" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub release created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Wait for CRAN submission confirmation email" >> $GITHUB_STEP_SUMMARY
          echo "2. Respond to any CRAN reviewer feedback" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor https://cran.r-project.org/web/checks/" >> $GITHUB_STEP_SUMMARY
