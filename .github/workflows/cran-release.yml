name: CRAN Release

# Public repo workflow with full validation before CRAN submission
# Stages 1-3: Validate the published package
# Stage 4: Submit to CRAN (final approval)

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers when publish-to-public pushes a version tag
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write
  packages: read

jobs:
  # Stage 1: Full CRAN validation on public repo
  validate-cran:
    name: "Stage 1: CRAN Validation (Public Repo)"
    if: github.repository == 'ericscheier/emburden'
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tarball: ${{ steps.build.outputs.tarball }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(grep "^Version:" DESCRIPTION | sed 's/^Version: *//')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found version: $VERSION"

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          use-public-rspm: true

      - name: Setup R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::rcmdcheck
            any::devtools
          needs: check

      - name: Setup Pandoc
        uses: r-lib/actions/setup-pandoc@v2

      - name: Setup TinyTeX
        uses: r-lib/actions/setup-tinytex@v2
        env:
          TINYTEX_INSTALLER: TinyTeX

      - name: Run CRAN checks (full build with vignettes)
        run: |
          echo "ðŸ” STAGE 1: Full CRAN validation on public repo (with vignettes)"
          Rscript -e "rcmdcheck::rcmdcheck(
            path = '.',
            args = c('--as-cran', '--no-manual'),
            build_args = c('--compact-vignettes=gs+qpdf'),
            error_on = 'warning',
            check_dir = 'check'
          )"

      - name: Build source package
        id: build
        run: |
          # Run R CMD build and capture tarball name
          R CMD build --compact-vignettes=gs+qpdf . | tee /tmp/build-output.txt
          tarball=$(grep -o "[a-zA-Z0-9._-]*\.tar\.gz" /tmp/build-output.txt | tail -1)
          echo "tarball=$tarball" >> $GITHUB_OUTPUT
          echo "Built package: $tarball"

      - name: Upload check results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: public-cran-check-results
          path: check/

      - name: Upload source tarball
        uses: actions/upload-artifact@v4
        with:
          name: r-package-source
          path: ${{ steps.build.outputs.tarball }}
          retention-days: 30

  # Stage 2: Testing dry-run on public repo
  dry-run-test:
    name: "Stage 2: Testing Dry-Run (Public Repo)"
    needs: validate-cran
    if: success()
    runs-on: ubuntu-latest
    environment: cran-testing  # No approval required

    steps:
      - name: Download package tarball
        uses: actions/download-artifact@v4
        with:
          name: r-package-source

      - name: Dry-run validation
        env:
          CRAN_EMAIL: ${{ secrets.CRAN_EMAIL }}
        run: |
          VERSION="${{ needs.validate-cran.outputs.version }}"
          TARBALL="${{ needs.validate-cran.outputs.tarball }}"

          echo "ðŸ” STAGE 2: Testing Dry-Run (Public Repo)"
          echo ""
          echo "Package: emburden v$VERSION"
          echo "Tarball: $TARBALL"
          echo "Email: $CRAN_EMAIL"
          echo "Repository: Public (ericscheier/emburden)"
          echo ""
          echo "âœ… Package validated successfully"
          echo "âœ… Vignettes built successfully"
          echo "âœ… All checks passed on public repo"
          echo ""
          echo "ðŸ“‹ Sequential Pipeline Progress:"
          echo "  âœ… Stage 1: Full CRAN validation complete (public repo)"
          echo "  âœ… Stage 2: Testing dry-run complete (current)"
          echo "  â³ Stage 3: Production dry-run (requires approval)"
          echo "  â³ Stage 4: Submit to CRAN (requires final approval)"

  # Stage 3: Production dry-run - final check before CRAN submission
  dry-run-prod:
    name: "Stage 3: Production Dry-Run (Approval Required)"
    needs: [validate-cran, dry-run-test]
    if: success()
    runs-on: ubuntu-latest
    environment: cran-production  # Requires manual approval

    steps:
      - name: Download package tarball
        uses: actions/download-artifact@v4
        with:
          name: r-package-source

      - name: Production dry-run preview
        env:
          CRAN_EMAIL: ${{ secrets.CRAN_EMAIL }}
        run: |
          VERSION="${{ needs.validate-cran.outputs.version }}"
          TARBALL="${{ needs.validate-cran.outputs.tarball }}"

          echo "ðŸ” STAGE 3: Production Dry-Run (Approval Granted)"
          echo ""
          echo "Package: emburden v$VERSION"
          echo "Tarball: $TARBALL"
          echo "Email: $CRAN_EMAIL"
          echo "Environment: cran-production (public repo)"
          echo ""
          echo "âœ… Package validated successfully on public repo"
          echo "âœ… Vignettes built successfully"
          echo "âœ… All checks passed"
          echo "âœ… Production approval granted"
          echo ""
          echo "ðŸ“‹ Sequential Pipeline Progress:"
          echo "  âœ… Stage 1: Full CRAN validation complete (public repo)"
          echo "  âœ… Stage 2: Testing dry-run complete"
          echo "  âœ… Stage 3: Production dry-run complete (current)"
          echo "  â³ Stage 4: Ready to submit to CRAN (requires final approval)"
          echo ""
          echo "ðŸ“Œ Ready to submit to CRAN!"

  # Stage 4: Final CRAN submission - requires approval
  submit-to-cran:
    name: "Stage 4: Submit to CRAN (Final Approval)"
    needs: [validate-cran, dry-run-prod]
    if: success()
    runs-on: ubuntu-latest
    environment: cran-production  # Requires manual approval

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          use-public-rspm: true

      - name: Install devtools
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::devtools
          dependencies: NA

      - name: Download package tarball
        uses: actions/download-artifact@v4
        with:
          name: r-package-source

      - name: Prepare CRAN submission
        run: |
          VERSION="${{ needs.validate-cran.outputs.version }}"
          TARBALL="${{ needs.validate-cran.outputs.tarball }}"

          cat > cran_comments.md << EOF
          ## Resubmission
          This is version $VERSION of the emburden package.

          ## Test environments
          * Ubuntu 22.04 (GitHub Actions), R-release
          * Windows (GitHub Actions), R-release
          * macOS (GitHub Actions), R-release

          ## R CMD check results
          There were no ERRORs, WARNINGs, or NOTEs.

          ## Downstream dependencies
          There are currently no downstream dependencies for this package.
          EOF

          echo "Package: emburden v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "Tarball: $TARBALL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CRAN Submission Comments" >> $GITHUB_STEP_SUMMARY
          cat cran_comments.md >> $GITHUB_STEP_SUMMARY

      - name: Submit to CRAN
        env:
          CRAN_EMAIL: ${{ secrets.CRAN_EMAIL }}
        run: |
          TARBALL="${{ needs.validate-cran.outputs.tarball }}"
          VERSION="${{ needs.validate-cran.outputs.version }}"

          echo "ðŸš€ STAGE 4: Submitting to CRAN (Final Approval Granted)"
          echo ""
          echo "================================"
          echo "  CRAN Submission"
          echo "================================"
          echo ""
          echo "Package: emburden v$VERSION"
          echo "Tarball: $TARBALL"
          echo "Email: $CRAN_EMAIL"
          echo "Repository: Public (ericscheier/emburden)"
          echo ""
          echo "ðŸ“‹ Complete Pipeline Status:"
          echo "  âœ… Private Repo - Stage 1: Full CRAN validation"
          echo "  âœ… Private Repo - Stage 2: Testing dry-run"
          echo "  âœ… Private Repo - Stage 3: Production dry-run (approved)"
          echo "  âœ… Private Repo - Stage 4: Published to public repo"
          echo "  âœ… Public Repo  - Stage 1: Full CRAN validation"
          echo "  âœ… Public Repo  - Stage 2: Testing dry-run"
          echo "  âœ… Public Repo  - Stage 3: Production dry-run (approved)"
          echo "  âœ… Public Repo  - Stage 4: Final approval granted (current)"
          echo ""
          echo "ðŸ“§ Submitting to CRAN now..."
          echo ""

          # Auto-submit to CRAN (uses maintainer email from DESCRIPTION)
          Rscript -e "devtools::submit_cran('$TARBALL')"

          echo ""
          echo "âœ… Package submitted to CRAN!"
          echo "ðŸ“¬ Check $CRAN_EMAIL for CRAN submission confirmation"

      - name: Upload tarball to release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.validate-cran.outputs.version }}"
          TARBALL="${{ needs.validate-cran.outputs.tarball }}"
          TAG="v$VERSION"

          echo "ðŸ“¦ Uploading CRAN-submitted tarball to release $TAG..."

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG exists, uploading tarball..."
            gh release upload "$TAG" "$TARBALL" --clobber
            echo "âœ… Uploaded $TARBALL to release $TAG"
          else
            echo "âš ï¸  Release $TAG does not exist yet"
            echo "Skipping tarball upload"
          fi

      - name: Post-submission summary
        if: always()
        run: |
          echo "### Stage 4: CRAN Submission Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Package Submitted to CRAN**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Complete Pipeline:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Private Repo - Stage 1: Full CRAN validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Private Repo - Stage 2: Testing dry-run" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Private Repo - Stage 3: Production dry-run (approved)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Private Repo - Stage 4: Published to public repo" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Public Repo  - Stage 1: Full CRAN validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Public Repo  - Stage 2: Testing dry-run" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Public Repo  - Stage 3: Production dry-run (approved)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Public Repo  - Stage 4: Submitted to CRAN (approved)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Wait for CRAN submission confirmation email" >> $GITHUB_STEP_SUMMARY
          echo "2. Respond to any CRAN reviewer feedback" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor https://cran.r-project.org/web/checks/" >> $GITHUB_STEP_SUMMARY
