# CRAN Preparation Check Workflow
# Runs comprehensive CRAN-readiness checks including URL validation,
# spell checking, and package size validation.
#
# Triggered by:
# - Manual workflow dispatch
# - PR labeled with 'cran-prep'

name: CRAN Prep Check

on:
  workflow_dispatch:
  pull_request:
    types: [labeled, synchronize]

# Only run if PR has 'cran-prep' label or manually triggered
# Skip if PR doesn't have the label
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Check if we should run (for PR triggers)
  check-label:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'cran-prep'))
    outputs:
      should-run: ${{ steps.check.outputs.result }}
    steps:
      - id: check
        run: echo "result=true" >> $GITHUB_OUTPUT

  cran-readiness:
    needs: check-label
    runs-on: ubuntu-latest

    name: CRAN Readiness Checks

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          use-public-rspm: true

      - uses: r-lib/actions/setup-tinytex@v2

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::rcmdcheck
            any::urlchecker
            any::spelling
          needs: check

      - name: Check URLs
        run: |
          Rscript -e "
          cat('\\n=== URL Validation ===\\n')
          urlchecker::url_check()
          "

      - name: Check Spelling
        run: |
          Rscript -e "
          cat('\\n=== Spell Check ===\\n')
          spelling::spell_check_package()
          "
        continue-on-error: true

      - name: Check Package Size
        run: |
          Rscript -e "
          cat('\\n=== Package Size Check ===\\n')
          pkg_file <- devtools::build(quiet = TRUE)
          size_mb <- file.size(pkg_file) / 1024^2
          cat(sprintf('Package size: %.2f MB\\n', size_mb))
          if (size_mb > 5) {
            warning(sprintf('Package size (%.2f MB) exceeds CRAN recommendation of 5 MB', size_mb))
          }
          "

      - name: Check with --as-cran
        uses: r-lib/actions/check-r-package@v2
        with:
          upload-snapshots: true
          build_args: 'c("--no-manual","--compact-vignettes=gs+qpdf")'
          args: 'c("--as-cran")'
          error-on: '"error"'

      - name: CRAN Submission Summary
        if: always()
        run: |
          Rscript -e "
          cat('\\n=== CRAN Readiness Summary ===\\n')
          cat('✓ URL validation completed\\n')
          cat('✓ Spell check completed\\n')
          cat('✓ Package size validated\\n')
          cat('✓ R CMD check --as-cran completed\\n')
          cat('\\nNext steps for CRAN submission:\\n')
          cat('1. Review cran-comments.md\\n')
          cat('2. Run devtools::check_win_devel()\\n')
          cat('3. Run devtools::check(remote = TRUE, manual = TRUE)\\n')
          cat('4. Submit via devtools::submit_cran() or web form\\n')
          "
